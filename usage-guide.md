# 区块链系统使用指南

本文档提供了如何使用和观察区块链系统的详细说明。

## 1. 系统架构

系统由三个主要组件组成：
- **两个区块链节点**：负责维护区块链、验证交易、挖矿等
- **一个客户端节点**：负责生成交易并发送给区块链节点

## 2. 启动系统

使用Docker Compose启动系统：

```bash
# 在项目根目录下运行
docker-compose up --build
```

要在后台运行系统：

```bash
docker-compose up -d --build
```

## 3. 观察系统运行

### 查看日志

查看所有容器的日志：

```bash
docker-compose logs -f
```

查看特定容器的日志：

```bash
docker-compose logs -f node1  # 查看节点1的日志
docker-compose logs -f node2  # 查看节点2的日志
docker-compose logs -f client # 查看客户端的日志
```

在日志中，您可以观察到以下关键事件：
- 新交易的生成和验证
- 区块的挖掘和确认
- 分叉的检测和解决

### 通过API查看系统状态

系统提供了多个API端点可以用来观察系统状态：

#### 获取区块链信息

```bash
curl http://localhost:5001/chain | jq .
```

#### 获取账户余额

```bash
curl http://localhost:5001/balance/<账户地址> | jq .
```

#### 获取系统统计信息

```bash
curl http://localhost:5001/stats | jq .
```

## 4. 关键流程观察

### 交易处理流程

1. 客户端生成随机交易并发送给两个节点
2. 节点验证交易（检查发送方余额、签名等）
3. 有效交易被添加到交易池
4. 挖矿过程中，交易被打包进区块
5. 新区块被广播并添加到区块链
6. 账户余额被更新

在日志中，您可以通过以下标识观察此流程：
- 💰 新交易
- ⛏️ 挖矿开始
- 💎 发现有效nonce
- ✅ 添加新区块

### 分叉检测和解决流程

当两个节点几乎同时挖出区块时，可能会产生分叉。系统使用最长链原则解决分叉。

在日志中，您可以通过以下标识观察此流程：
- ⚠️ 分叉检测
- 🔄 分叉解决（切换到更长的链）

要人为触发分叉情况，可以暂时断开两个节点之间的通信（例如，停止一个节点），让它们独立挖矿一段时间，然后恢复通信。

## 5. 常见问题排查

### 节点无法启动

检查Docker容器状态和日志：

```bash
docker ps
docker-compose logs node1
```

### 交易不被确认

可能的原因：
- 发送方余额不足
- 交易签名无效
- 交易池已满

查看节点日志了解具体原因。

### 节点间数据不一致

可能存在网络通信问题或分叉情况。查看两个节点的区块链长度是否一致：

```bash
curl http://localhost:5001/chain | jq .length
curl http://localhost:5002/chain | jq .length
```

如果不一致，可能正在进行分叉解决。

## 6. 定制系统参数

您可以通过修改docker-compose.yml中的环境变量来调整系统参数：

```yaml
environment:
  - MINING_DIFFICULTY=3    # 调整挖矿难度
  - TRANSACTION_INTERVAL=0.1  # 调整交易生成频率
  - LOG_LEVEL=INFO         # 调整日志级别
```

参数修改后需要重启系统：

```bash
docker-compose down
docker-compose up -d
```

## 7. 观察特定场景

### 大额交易处理

系统会自动生成一些大额交易（超过账户余额的80%），观察日志中标有"大额交易"的信息。

### 系统状态监控

每5个区块，系统会自动打印区块链状态信息和前5名账户余额。

---

通过以上方法，您可以全面了解区块链系统的运行机制，观察交易处理、挖矿、区块确认以及分叉解决等核心流程。